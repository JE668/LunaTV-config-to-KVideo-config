name: Merge Resources

on:
  schedule:
    # æ¯å¤©å‡Œæ™¨2ç‚¹è¿è¡Œ
    - cron: '0 0/6 * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    branches:
      - main
    paths:
      - '**.yml'
      - '**.yaml'

jobs:
  merge-resources:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Create merge script
      run: |
        cat > merge.js << 'EOF'
        const fs = require('fs');
        const https = require('https');
        const { URL } = require('url');

        // ä»URLè·å–JSONæ•°æ®
        function fetchJSON(url) {
          return new Promise((resolve, reject) => {
            https.get(url, (res) => {
              let data = '';
              res.on('data', (chunk) => data += chunk);
              res.on('end', () => {
                try {
                  resolve(JSON.parse(data));
                } catch (e) {
                  reject(e);
                }
              });
            }).on('error', reject);
          });
        }

        // ä»URLä¸­æå–åŸŸåä½œä¸ºid
        function extractDomainId(url) {
          try {
            const parsed = new URL(url);
            const hostname = parsed.hostname;
            // ç§»é™¤å¸¸è§å‰ç¼€å’Œåç¼€ï¼Œä¿ç•™æ ¸å¿ƒåŸŸå
            const domain = hostname
              .replace(/^www\./, '')
              .replace(/^api\./, '')
              .replace(/^caiji\./, '')
              .replace(/\.(com|cn|net|org|tv)$/, '')
              .split('.')[0];
            return domain.toLowerCase();
          } catch {
            return null;
          }
        }

        async function main() {
          try {
            console.log('å¼€å§‹å¤„ç†æ•°æ®...');
            
            // 1. æ‹‰å–å¹¶è½¬æ¢ jingjian.json
            const jingjianData = await fetchJSON('https://raw.githubusercontent.com/hafrey1/LunaTV-config/refs/heads/main/jingjian.json');
            console.log(`ä» jingjian.json è·å–äº† ${Object.keys(jingjianData).length} æ¡æ•°æ®`);
            
            const convertedData = [];
            let priorityCounter = 100; // ä»100å¼€å§‹ï¼Œé¿å…ä¸test.jsonå†²çª
            
            for (const [key, value] of Object.entries(jingjianData)) {
              // ä½¿ç”¨åŸŸåä½œä¸ºidï¼Œæˆ–è€…ä»keyä¸­æå–
              let id = extractDomainId(value.api || key);
              if (!id) {
                // å¦‚æœæ— æ³•ä»URLæå–ï¼Œä½¿ç”¨keyçš„ä¸€éƒ¨åˆ†
                id = key.replace(/[^a-zA-Z0-9]/g, '_').toLowerCase();
              }
              
              // ç¡®ä¿idä¸ä¸ºç©º
              if (!id) {
                id = `resource_${priorityCounter}`;
              }
              
              convertedData.push({
                id: id,
                name: value.name || key,
                baseUrl: value.api,
                group: "normal",
                enabled: true,
                priority: priorityCounter++
              });
            }
            
            console.log(`è½¬æ¢äº† ${convertedData.length} æ¡æ•°æ®`);
            
            // 2. æ‹‰å– test.json
            const testData = await fetchJSON('https://raw.githubusercontent.com/rapier15sapper/ew/refs/heads/main/test.json');
            console.log(`ä» test.json è·å–äº† ${testData.length} æ¡æ•°æ®`);
            
            // 3. åˆå¹¶å»é‡ï¼ˆä¼˜å…ˆä¿ç•™test.jsonçš„æ•°æ®ï¼‰
            const mergedMap = new Map();
            
            // å…ˆæ·»åŠ test.jsonçš„æ•°æ®
            testData.forEach(item => {
              if (item.id) {
                mergedMap.set(item.id, item);
              }
            });
            
            // å†æ·»åŠ è½¬æ¢çš„æ•°æ®ï¼Œå¦‚æœidå·²å­˜åœ¨åˆ™è·³è¿‡ï¼ˆä¿ç•™test.jsonçš„ï¼‰
            convertedData.forEach(item => {
              if (item.id && !mergedMap.has(item.id)) {
                mergedMap.set(item.id, item);
              }
            });
            
            // è½¬æ¢ä¸ºæ•°ç»„å¹¶æŒ‰priorityæ’åº
            const finalData = Array.from(mergedMap.values())
              .sort((a, b) => (a.priority || 999) - (b.priority || 999));
            
            console.log(`åˆå¹¶å»é‡åå…±æœ‰ ${finalData.length} æ¡æ•°æ®`);
            
            // 4. å†™å…¥è¾“å‡ºæ–‡ä»¶
            const outputFile = 'merged-resources.json';
            fs.writeFileSync(outputFile, JSON.stringify(finalData, null, 2));
            console.log(`æ•°æ®å·²ä¿å­˜åˆ° ${outputFile}`);
            
            // 5. åˆ›å»ºæ›´æ˜“è¯»çš„æ ¼å¼ï¼ˆå¯é€‰ï¼‰
            const prettyOutput = finalData.map(item => 
              `    ${JSON.stringify(item, null, 8)}`
            ).join(',\n');
            
            fs.writeFileSync('formatted-resources.json', `[\n${prettyOutput}\n]`);
            console.log('æ ¼å¼åŒ–æ•°æ®å·²ä¿å­˜');
            
          } catch (error) {
            console.error('å¤„ç†è¿‡ç¨‹ä¸­å‡ºé”™:', error);
            process.exit(1);
          }
        }

        main();
        EOF
        
    - name: Run merge script
      run: node merge.js
      
    - name: Check for changes
      id: check_changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶å˜æ›´
        if git diff --quiet HEAD merged-resources.json; then
          echo "changes=false" >> $GITHUB_OUTPUT
          echo "æ²¡æœ‰æ£€æµ‹åˆ°å˜æ›´"
        else
          echo "changes=true" >> $GITHUB_OUTPUT
          echo "æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´"
        fi
        
    - name: Commit and push if changed
      if: steps.check_changes.outputs.changes == 'true'
      run: |
        git add merged-resources.json formatted-resources.json
        git commit -m "ğŸ”„ è‡ªåŠ¨æ›´æ–°åˆå¹¶èµ„æºæ•°æ® [$(date +'%Y-%m-%d %H:%M:%S')]"
        git push
